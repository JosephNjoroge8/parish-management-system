# Optimized cPanel Deployment Configuration
# Fast and reliable deployment for Parish Management System
# Documentation: https://docs.cpanel.net/knowledge-base/web-services/guide-to-git-deployment/

---
deployment:
  tasks:
    # Step 1: Initialize deployment path
    - export DEPLOYPATH=/home2/shemidig/parish_system/
    - echo "ğŸš€ Starting deployment to $DEPLOYPATH"
    
    # Step 2: Fast bulk copy (much faster than individual file copies)
    - echo "ğŸ“ Copying application files..."
    - /bin/cp -R . $DEPLOYPATH/ 2>/dev/null || true
    
    # Step 3: Remove git files from deployment (security & space)
    - /bin/rm -rf $DEPLOYPATH/.git
    - /bin/rm -f $DEPLOYPATH/.gitignore
    - echo "ğŸ—‘ï¸ Git files removed from deployment"
    
    # Step 4: Essential file permissions (fast approach)
    - echo "ğŸ”’ Setting essential permissions..."
    - chmod -R 755 $DEPLOYPATH
    - chmod -R 777 $DEPLOYPATH/storage $DEPLOYPATH/bootstrap/cache 2>/dev/null || true
    
    # Step 5: Environment check and Laravel setup
    - echo "âš™ï¸ Setting up Laravel environment..."
    - |
      cd $DEPLOYPATH
      if [ ! -f .env ]; then
        if [ -f .env.example ]; then
          cp .env.example .env
          echo "ğŸ“‹ Created .env from template - EDIT WITH YOUR DATABASE CREDENTIALS!"
        else
          echo "âŒ ERROR: No .env or .env.example found!"
          exit 1
        fi
      else
        echo "âœ… .env file exists"
      fi
    
    # Step 6: Laravel optimization (essential commands only)
    - echo "ğŸš€ Optimizing Laravel..."
    - |
      cd $DEPLOYPATH
      
      # Generate app key if needed
      /usr/local/bin/ea-php82 artisan key:generate --force --no-interaction || echo "Key generation skipped"
      
      # Clear caches (fast)
      /usr/local/bin/ea-php82 artisan config:clear --no-interaction || true
      /usr/local/bin/ea-php82 artisan cache:clear --no-interaction || true
      
      # Run migrations (with timeout protection)
      timeout 60 /usr/local/bin/ea-php82 artisan migrate --force --no-interaction || echo "Migration timeout/error - check manually"
      
      # Create storage link
      /usr/local/bin/ea-php82 artisan storage:link --no-interaction || true
      
      # Production optimization
      /usr/local/bin/ea-php82 artisan config:cache --no-interaction || true
      /usr/local/bin/ea-php82 artisan route:cache --no-interaction || true
      
      echo "âœ… Laravel setup completed"

    # Step 7: Final security and verification
    - echo "ğŸ” Final security settings..."
    - |
      cd $DEPLOYPATH
      
      # Secure .env file
      [ -f .env ] && chmod 600 .env
      
      # Remove any development files that might have been copied
      rm -f debug_*.php test_*.php *.log 2>/dev/null || true
      
      # Verify Laravel is working
      if /usr/local/bin/ea-php82 artisan --version >/dev/null 2>&1; then
        echo "ğŸ‰ Parish Management System Deployed Successfully!"
        echo "ğŸŒ Access your system at: http://parish.quovadisyouthhub.org/"
        echo "ï¿½ Remember to verify your .env database settings!"
      else
        echo "âš ï¸ Deployment completed but Laravel check failed - verify manually"
      fi