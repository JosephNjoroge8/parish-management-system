# Optimized cPanel Deployment Configuration
# Fast and reliable deployment for Parish Management System
# Documentation: https://docs.cpanel.net/knowledge-base/web-services/guide-to-git-deployment/

---
deployment:
  tasks:
    # Step 1: Initialize deployment path
    - export DEPLOYPATH=/home2/shemidig/parish_system/
    - echo "ğŸš€ Starting deployment to $DEPLOYPATH"
    
    # Step 2: Fast bulk copy (much faster than individual file copies)
    - echo "ğŸ“ Copying application files..."
    - /bin/cp -R . $DEPLOYPATH/ 2>/dev/null || true
    
    # Step 3: Remove git files from deployment (security & space)
    - /bin/rm -rf $DEPLOYPATH/.git
    - /bin/rm -f $DEPLOYPATH/.gitignore
    - echo "ğŸ—‘ï¸ Git files removed from deployment"
    
    # Step 4: Essential file permissions (fast approach)
    - echo "ğŸ”’ Setting essential permissions..."
    - chmod -R 755 $DEPLOYPATH
    - chmod -R 777 $DEPLOYPATH/storage $DEPLOYPATH/bootstrap/cache 2>/dev/null || true
    
    # Step 5: Environment check and Laravel setup
    - echo "âš™ï¸ Setting up Laravel environment..."
    - |
      cd $DEPLOYPATH
      if [ ! -f .env ]; then
        if [ -f .env.example ]; then
          cp .env.example .env
          echo "ğŸ“‹ Created .env from template - EDIT WITH YOUR DATABASE CREDENTIALS!"
        else
          echo "âŒ ERROR: No .env or .env.example found!"
          exit 1
        fi
      else
        echo "âœ… .env file exists"
      fi
    
    # Step 6: Laravel optimization (essential commands only)
    - echo "ğŸš€ Optimizing Laravel..."
    - |
      cd $DEPLOYPATH
      
      # Generate app key if needed
      /usr/local/bin/ea-php82 artisan key:generate --force --no-interaction || echo "Key generation skipped"
      
      # Clear caches (fast)
      /usr/local/bin/ea-php82 artisan config:clear --no-interaction || true
      /usr/local/bin/ea-php82 artisan cache:clear --no-interaction || true
      
      # Run migrations (with timeout protection)
      timeout 60 /usr/local/bin/ea-php82 artisan migrate --force --no-interaction || echo "Migration timeout/error - check manually"
      
      # Run all seeders after migration
      /usr/local/bin/ea-php82 artisan db:seed --force --no-interaction || echo "Seeder execution failed - check manually"
      
      # Create storage link
      /usr/local/bin/ea-php82 artisan storage:link --no-interaction || true
      
      # Production optimization
      /usr/local/bin/ea-php82 artisan config:cache --no-interaction || true
      /usr/local/bin/ea-php82 artisan route:cache --no-interaction || true
      
      echo "âœ… Laravel setup completed"

    # Step 7: Final security and verification
    - echo "ğŸ” Final security settings..."
    - |
      cd $DEPLOYPATH
      
      # Secure .env file
      [ -f .env ] && chmod 600 .env
      
      # Remove any development files that might have been copied
      rm -f debug_*.php test_*.php *.log 2>/dev/null || true
      
      # Verify Laravel is working
      if /usr/local/bin/ea-php82 artisan --version >/dev/null 2>&1; then
        echo "ğŸ‰ Parish Management System Deployed Successfully!"
        echo "ğŸŒ Access your system at: http://parish.quovadisyouthhub.org/"
        echo "ğŸ“ Remember to verify your .env database settings!"
      else
        echo "âš ï¸ Deployment completed but Laravel check failed - verify manually"
      fi
        }
        
        # Seed essential system data
        echo "ğŸŒ± Seeding essential system data..."
        
        # Roles and permissions (critical for system operation)
        if $PHP_PATH artisan db:seed --class=RolePermissionSeeder --force --no-interaction 2>/dev/null; then
          echo "âœ… Roles and permissions seeded"
        else
          echo "â„¹ï¸  Roles/permissions already exist or seeder unavailable"
        fi
        
        # Production configuration and admin user
        if $PHP_PATH artisan db:seed --class=ProductionSeeder --force --no-interaction 2>/dev/null; then
          echo "âœ… Production configuration seeded"
        else
          echo "â„¹ï¸  Production data already exists or seeder unavailable"
        fi
        
        # Complete database seeding (optional)
        if $PHP_PATH artisan db:seed --force --no-interaction 2>/dev/null; then
          echo "âœ… Complete database seeding successful"
        else
          echo "â„¹ï¸  Database already seeded or no additional seeders"
        fi
        
      else
        echo "â­ï¸ Skipping database operations due to connection issues"
        echo "ğŸ› ï¸  Manual setup required after fixing database connection"
      fi

    # Step 10: Laravel production optimization
    - echo "âš¡ Applying production optimizations..."
    - |
      cd $DEPLOYPATH
      
      # Create storage symlink
      $PHP_PATH artisan storage:link --no-interaction 2>/dev/null || echo "â„¹ï¸ Storage link already exists"
      
      # Cache configurations for production performance
      $PHP_PATH artisan config:cache --no-interaction 2>/dev/null || echo "âš ï¸ Config cache failed"
      $PHP_PATH artisan route:cache --no-interaction 2>/dev/null || echo "âš ï¸ Route cache failed"
      $PHP_PATH artisan view:cache --no-interaction 2>/dev/null || echo "âš ï¸ View cache failed"
      
      echo "âœ… Production optimizations applied"

    # Step 11: Final verification and security
    - echo "ğŸ” Final security and system verification..."
    - |
      cd $DEPLOYPATH
      
      # Final security settings
      [ -f .env ] && chmod 600 .env
      
      # Verify Laravel is functional
      LARAVEL_CHECK=$($PHP_PATH artisan --version 2>&1)
      if echo "$LARAVEL_CHECK" | grep -q "Laravel Framework"; then
        echo ""
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "==============================================="
        echo "ğŸŒ Parish Management System is now live at:"
        echo "   ğŸ‘‰ http://parish.quovadisyouthhub.org/"
        echo ""
        echo "âœ… Deployment Summary:"
        echo "   ğŸ“Š Laravel Version: $LARAVEL_CHECK"
        echo "   ğŸ—„ï¸  Database: $([ "$DB_CONNECTED" = "true" ] && echo "âœ… Connected" || echo "âŒ Connection Failed")"
        echo "   ğŸ”§ Seeders: $([ "$DB_CONNECTED" = "true" ] && echo "âœ… Executed" || echo "â­ï¸ Skipped")"
        echo "   âš¡ Optimizations: âœ… Applied"
        echo ""
        if [ "$DB_CONNECTED" = "true" ]; then
          echo "ğŸš€ System Ready! You can now:"
          echo "   1. ğŸ‘¤ Log in with your admin credentials"
          echo "   2. âœ… Test all system features"
          echo "   3. ğŸ“Š Verify reports and data integrity"
        else
          echo "âš ï¸  Database Setup Required:"
          echo "   1. ğŸ”§ Fix database connection in .env"
          echo "   2. ğŸƒ Run: $PHP_PATH artisan migrate --force"
          echo "   3. ğŸŒ± Run: $PHP_PATH artisan db:seed --force"
        fi
        echo ""
        echo "ğŸ”§ Useful Commands:"
        echo "   Clear cache: $PHP_PATH artisan cache:clear"
        echo "   Re-run seeders: $PHP_PATH artisan db:seed --force"
        echo "   Check status: $PHP_PATH artisan --version"
        echo ""
        echo "ğŸ“… Deployment completed at: $(date)"
        echo "==============================================="
      else
        echo ""
        echo "âš ï¸ DEPLOYMENT WARNING"
        echo "============================="
        echo "Files copied but Laravel verification failed:"
        echo "$LARAVEL_CHECK"
        echo ""
        echo "ğŸ› ï¸  Troubleshooting steps:"
        echo "   1. Check file permissions"
        echo "   2. Verify .env configuration"
        echo "   3. Run manual Laravel commands"
        echo "============================="
      fi