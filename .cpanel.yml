# Lightning-Fast cPanel Deployment
# Optimized for speed - under 2 minutes

---
deployment:
  tasks:
    # Instant setup
    - export DEPLOYPATH=/home2/shemidig/parish_system/
    
    # Copy only changed files (fastest method)
    - rsync -av --delete --exclude='.git' --exclude='node_modules' --exclude='storage/logs' . $DEPLOYPATH/
    
    # Essential permissions only
    - chmod -R 755 $DEPLOYPATH && chmod -R 777 $DEPLOYPATH/storage $DEPLOYPATH/bootstrap/cache
    
    # Minimal Laravel setup
    - |
      cd $DEPLOYPATH
      [ ! -f .env ] && cp .env.example .env 2>/dev/null
      /usr/local/bin/ea-php82 artisan config:clear
      /usr/local/bin/ea-php82 artisan migrate --force
      echo "âœ… Deployed in under 2 minutes!"
        }
        
        # Seed essential system data
        echo "ğŸŒ± Seeding essential system data..."
        
        # Roles and permissions (critical for system operation)
        if $PHP_PATH artisan db:seed --class=RolePermissionSeeder --force --no-interaction 2>/dev/null; then
          echo "âœ… Roles and permissions seeded"
        else
          echo "â„¹ï¸  Roles/permissions already exist or seeder unavailable"
        fi
        
        # Production configuration and admin user
        if $PHP_PATH artisan db:seed --class=ProductionSeeder --force --no-interaction 2>/dev/null; then
          echo "âœ… Production configuration seeded"
        else
          echo "â„¹ï¸  Production data already exists or seeder unavailable"
        fi
        
        # Complete database seeding (optional)
        if $PHP_PATH artisan db:seed --force --no-interaction 2>/dev/null; then
          echo "âœ… Complete database seeding successful"
        else
          echo "â„¹ï¸  Database already seeded or no additional seeders"
        fi
        
      else
        echo "â­ï¸ Skipping database operations due to connection issues"
        echo "ğŸ› ï¸  Manual setup required after fixing database connection"
      fi

    # Step 10: Laravel production optimization
    - echo "âš¡ Applying production optimizations..."
    - |
      cd $DEPLOYPATH
      
      # Create storage symlink
      $PHP_PATH artisan storage:link --no-interaction 2>/dev/null || echo "â„¹ï¸ Storage link already exists"
      
      # Cache configurations for production performance
      $PHP_PATH artisan config:cache --no-interaction 2>/dev/null || echo "âš ï¸ Config cache failed"
      $PHP_PATH artisan route:cache --no-interaction 2>/dev/null || echo "âš ï¸ Route cache failed"
      $PHP_PATH artisan view:cache --no-interaction 2>/dev/null || echo "âš ï¸ View cache failed"
      
      echo "âœ… Production optimizations applied"

    # Step 11: Final verification and security
    - echo "ğŸ” Final security and system verification..."
    - |
      cd $DEPLOYPATH
      
      # Final security settings
      [ -f .env ] && chmod 600 .env
      
      # Verify Laravel is functional
      LARAVEL_CHECK=$($PHP_PATH artisan --version 2>&1)
      if echo "$LARAVEL_CHECK" | grep -q "Laravel Framework"; then
        echo ""
        echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
        echo "==============================================="
        echo "ğŸŒ Parish Management System is now live at:"
        echo "   ğŸ‘‰ http://parish.quovadisyouthhub.org/"
        echo ""
        echo "âœ… Deployment Summary:"
        echo "   ğŸ“Š Laravel Version: $LARAVEL_CHECK"
        echo "   ğŸ—„ï¸  Database: $([ "$DB_CONNECTED" = "true" ] && echo "âœ… Connected" || echo "âŒ Connection Failed")"
        echo "   ğŸ”§ Seeders: $([ "$DB_CONNECTED" = "true" ] && echo "âœ… Executed" || echo "â­ï¸ Skipped")"
        echo "   âš¡ Optimizations: âœ… Applied"
        echo ""
        if [ "$DB_CONNECTED" = "true" ]; then
          echo "ğŸš€ System Ready! You can now:"
          echo "   1. ğŸ‘¤ Log in with your admin credentials"
          echo "   2. âœ… Test all system features"
          echo "   3. ğŸ“Š Verify reports and data integrity"
        else
          echo "âš ï¸  Database Setup Required:"
          echo "   1. ğŸ”§ Fix database connection in .env"
          echo "   2. ğŸƒ Run: $PHP_PATH artisan migrate --force"
          echo "   3. ğŸŒ± Run: $PHP_PATH artisan db:seed --force"
        fi
        echo ""
        echo "ğŸ”§ Useful Commands:"
        echo "   Clear cache: $PHP_PATH artisan cache:clear"
        echo "   Re-run seeders: $PHP_PATH artisan db:seed --force"
        echo "   Check status: $PHP_PATH artisan --version"
        echo ""
        echo "ğŸ“… Deployment completed at: $(date)"
        echo "==============================================="
      else
        echo ""
        echo "âš ï¸ DEPLOYMENT WARNING"
        echo "============================="
        echo "Files copied but Laravel verification failed:"
        echo "$LARAVEL_CHECK"
        echo ""
        echo "ğŸ› ï¸  Troubleshooting steps:"
        echo "   1. Check file permissions"
        echo "   2. Verify .env configuration"
        echo "   3. Run manual Laravel commands"
        echo "============================="
      fi